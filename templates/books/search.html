{% extends 'base.html' %}
{% load static %}

{% block content %}
  <div class="search-bg">
    <h1 class="search-title">ğŸ” æœå°‹æ›¸ç±</h1>

    <!-- æœå°‹è¡¨å–® -->
    <form method="get" action="{% url 'books:search' %}" class="search-form">
      <select name="category" class="form-select">
        <option value="">å…¨éƒ¨åˆ†é¡</option>
        <option value="æ–‡å­¸">æ–‡å­¸</option>
        <option value="ç¤¾æœƒç§‘å­¸">ç¤¾æœƒç§‘å­¸</option>
        <option value="å•†æ¥­è²¡ç¶“">å•†æ¥­è²¡ç¶“</option>
        <option value="é£²é£Ÿæ–‡åŒ–">é£²é£Ÿæ–‡åŒ–</option>
        <option value="å¿ƒç†å‹µå¿—">å¿ƒç†å‹µå¿—</option>
        <option value="å…¶ä»–">å…¶ä»–</option>
      </select>
      <select name="price" class="form-select">
        <option value="">å…¨éƒ¨åƒ¹éŒ¢</option>
        <option value="0-100">$0 - $100</option>
        <option value="101-200">$101 - $200</option>
        <option value="201-500">$201 - $500</option>
        <option value="501-">$501 ä»¥ä¸Š</option>
      </select>
      <input type="text" name="q" value="{{ query }}" placeholder="è¼¸å…¥æ›¸åæˆ–ä½œè€…" class="form-input">
      <button type="submit" class="form-button">ğŸ” æœå°‹</button>
    </form>

    <!-- æœå°‹çµæœ -->
    <h2 class="results-title">æœå°‹çµæœ</h2>
    <div class="infinite-container">
      {% if books %}
        {% for book in books %}
          <div class="infinite-item">
            <div class="book-card book-card-fixed">
              {% if book.photo_large %}
                <a href="{% url 'books:book' book.id %}">
                  <img src="{{ book.photo_small.url }}" alt="{{ book.title }}" class="book-image">
                </a>
              {% else %}
                <img src="{% static 'images/default_book.jpg' %}" alt="Default Image" class="book-image">
              {% endif %}
              <div class="book-info">
                <h2 class="book-title">{{ book.title|truncatechars:30 }}</h2>
                <p class="book-author">ä½œè€…ï¼š{{ book.author }}</p>
                <p class="book-price">åƒ¹æ ¼ï¼š${{ book.price }}</p>
                <p class="book-isbn">ISBNï¼š{{ book.isbn }}</p>
              </div>
            </div>
          </div>
        {% empty %}
          <p class="no-results">æ²’æœ‰æ‰¾åˆ°ç›¸é—œæ›¸ç±ã€‚</p>
        {% endfor %}
      {% endif %}
    </div>

    <!-- ç„¡é™æ»¾å‹•éˆæ¥ -->
    {% if books.has_next %}
      <a href="{% url 'books:search' %}?q={{ query }}&page={{ books.next_page_number }}" class="infinite-more-link"></a>
    {% endif %}

    <!-- åŠ è¼‰æç¤º -->
    <div class="loading" style="display: none;">åŠ è¼‰ä¸­...</div>
  </div>
{% endblock content %}

{% block extra_js %}
<script>
  $(document).ready(function() {
    // å…ˆç¦ç”¨ Waypoint Infinite çš„è‡ªå‹•è¼‰å…¥
    var infinite = new Waypoint.Infinite({
      element: $('.infinite-container')[0],
      offset: 'bottom-in-view',
      onBeforePageLoad: function() {
        $('.loading').show();
        return false; // é˜»æ­¢è‡ªå‹• AJAX è¼‰å…¥
      },
      onAfterPageLoad: function() {
        setTimeout(function() {
          $('.loading').hide();
        }, 3000); // é€™è£¡è¨­ç½®å»¶é²æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰å¥½ä¼¼å†‡ä½œç”¨
      }
    });

    // æ””æˆª infinite-more-link çš„é»æ“Šå’Œè‡ªå‹•è§¸ç™¼
    $(document).on('click', '.infinite-more-link', function(e) {
      e.preventDefault();
      var link = $(this);
      $('.loading').show();
      setTimeout(function() {
        // æ‰‹å‹•è§¸ç™¼ AJAX è¼‰å…¥
        link[0].click();
      }, 3000); // é€™è£¡è¨­ç½®å»¶é²æ™‚é–“ï¼ˆæ¯«ç§’ï¼‰å¥½ä¼¼å†‡ä½œç”¨
    });
  });
</script>
{% endblock extra_js %}